<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:sec="http://www.springframework.org/schema/security"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd
        http://www.springframework.org/schema/util
        http://www.springframework.org/schema/util/spring-util.xsd">

    <!-- Resources do not need security -->
    <sec:http pattern="/**/*.css" security="none" />
    <sec:http pattern="/**/*.js" security="none" />
    <sec:http pattern="/img/**" security="none" />
    <sec:http pattern="/fonts/**" security="none" />
    <sec:http pattern="/**/${asset.server.url.prefix.internal}/**" security="none" />
    <sec:http pattern="/favicon.ico" security="none" />
    <sec:http pattern="/robots.txt" security="none" />
    <sec:http pattern="/forgotUsername" security="none" />
    <sec:http pattern="/forgotPassword" security="none" />
    <sec:http pattern="/resetPassword" security="none" />
    <sec:http pattern="/sendResetPassword" security="none" />

    <!-- Set up Spring security for the application -->
    <sec:http auto-config="false"
            authentication-manager-ref="blAdminAuthenticationManager"
            disable-url-rewriting="true">
        
        <sec:csrf disabled="true"/>
        <sec:headers>
            <sec:frame-options disabled="true"/>
        </sec:headers>

        <sec:intercept-url pattern="/sendResetPassword" access="permitAll"/>
        <sec:intercept-url pattern="/forgotUsername" access="permitAll"/>
        <sec:intercept-url pattern="/forgotPassword" access="permitAll"/>
        <sec:intercept-url pattern="/resetPassword" access="permitAll"/>
        <sec:intercept-url pattern="/login" access="permitAll"/>
        <sec:intercept-url pattern="/**" access="isAuthenticated()"  requires-channel="any" />
        
        <!-- Define the login form along with the success and failure handlers -->
        <sec:form-login 
            authentication-success-handler-ref="blAdminAuthenticationSuccessHandler"
            authentication-failure-handler-ref="blAdminAuthenticationFailureHandler"
            login-processing-url="/login_admin_post"
            login-page="/login"
        />
        
        <!-- Provide the logout handler -->
        <sec:logout invalidate-session="true"
                    logout-url="/adminLogout.htm"
                    logout-success-url="/login"/>

        <!-- Since we run this alongside the site, we need to set up the special port mapping -->
        <!-- This isn't necessary for site becauase it utilizes a default mapping -->
        <!-- Note that since we are providing a special mapping, we must repeat the default ones -->
        <sec:port-mappings>
            <sec:port-mapping http="80" https="443"/>
            <sec:port-mapping http="8080" https="8443"/>
            <sec:port-mapping http="8081" https="8444"/>
        </sec:port-mappings>
        
        <!-- Specify our custom filters -->
        <sec:custom-filter ref="blPreSecurityFilterChain" before="CHANNEL_FILTER"/>
        <sec:custom-filter ref="blAdminCsrfFilter" before="FORM_LOGIN_FILTER"/>
        <sec:custom-filter ref="blPostSecurityFilterChain" after="SWITCH_USER_FILTER"/>
    </sec:http>
    
    <!-- The BLC Admin authentication manager -->
    <sec:authentication-manager alias="blAdminAuthenticationManager">
        <sec:authentication-provider ref="blAdminAuthenticationProvider" />
    </sec:authentication-manager>
    
    <!-- Sets the login failure URL -->
    <bean id="blAdminAuthenticationFailureHandler" class="org.broadleafcommerce.openadmin.security.BroadleafAdminAuthenticationFailureHandler">
        <constructor-arg value="/login?login_error=true" />
    </bean>

    <!-- Sets the login success URL -->
    <bean id="blAdminAuthenticationSuccessHandler" class="org.broadleafcommerce.openadmin.security.BroadleafAdminAuthenticationSuccessHandler">
        <property name="defaultTargetUrl" value="/loginSuccess"/>
        <property name="alwaysUseDefaultTargetUrl" value="false"/>
    </bean>
    
    <!-- Allow the @Secured annotations -->
    <sec:global-method-security secured-annotations="enabled" pre-post-annotations="enabled" />
    
</beans>
